<script lang="ts">
  import { createRawEventDispatcher, forwardEventHandlers, T } from '@threlte/core'
  // @ts-ignore
  import type { GLTF as ThreeGLTF } from 'three/examples/jsm/loaders/GLTFLoader'
  import { useGltf } from '../../hooks/useGltf'
  import type { ThrelteGltf } from '../../types/types'
  import type { GltfEvents, GltfProps, GltfSlots } from './GLTF.svelte.js'
	import {getContext} from "svelte";
	import {InstancedMesh} from "three";

  type $$Props = GltfProps
  type $$Events = GltfEvents
  type $$Slots = GltfSlots

  const component = forwardEventHandlers()
	const instances = getContext<{[key:string]: any}>('threlte-gltf-context')

  export let url: $$Props['url']

  export let useDraco: $$Props['useDraco'] = false
  export let useMeshopt: $$Props['useMeshopt'] = false
  export let ktxTranscoderPath: $$Props['ktxTranscoderPath'] = undefined

  type AnyThrelteGltf = ThrelteGltf<{
    nodes: Record<string, any>
    materials: Record<string, any>
  }>

  const dispatch = createRawEventDispatcher<{
    load: ThreeGLTF
    unload: undefined
    error: string
  }>()

  export let gltf: AnyThrelteGltf | undefined = undefined
  export let scene: ThreeGLTF['scene'] | undefined = undefined
  export let animations: ThreeGLTF['animations'] | undefined = undefined
  export let asset: ThreeGLTF['asset'] | undefined = undefined
  export let cameras: ThreeGLTF['cameras'] | undefined = undefined
  export let scenes: ThreeGLTF['scenes'] | undefined = undefined
  export let userData: ThreeGLTF['userData'] | undefined = undefined
  export let parser: ThreeGLTF['parser'] | undefined = undefined
  export let materials: AnyThrelteGltf['materials'] | undefined = undefined
  export let nodes: AnyThrelteGltf['nodes'] | undefined = undefined

  const loader = useGltf({
    useDraco: useDraco
      ? typeof useDraco === 'string'
        ? useDraco
        : 'https://www.gstatic.com/draco/v1/decoders/'
      : undefined,
    useMeshopt,
    ktxTranscoderPath
  })

  const onLoad = (data: AnyThrelteGltf) => {
    if (gltf) dispatch('unload')

    gltf = data
    scene = data.scene
    animations = data.animations
    asset = data.asset
    cameras = data.cameras
    scenes = data.scenes
    userData = data.userData
    parser = data.parser
    materials = data.materials
    nodes = data.nodes

    dispatch('load', gltf)
  }

  const onError = (error: any) => {
    console.error(`Error loading GLTF: ${error.message}`)
    gltf = undefined
    scene = undefined
    animations = undefined
    asset = undefined
    cameras = undefined
    scenes = undefined
    userData = undefined
    parser = undefined
    nodes = undefined
    materials = undefined
    dispatch('error', error.message)
  }

  const loadGltf = async (url: string) => {
    try {
      const model = await loader.load(url)
			const geo = model.scene.children[0].geometry.clone();
			const ins = new InstancedMesh(geo, model.scene.children[0].material, 1000);
			console.log(ins)
      onLoad(model)
    } catch (error: any) {
      onError(error)
    }
  }

  $: loadGltf(url)
</script>

{#if scene}
  <T is={scene} {...$$restProps} let:ref bind:this={$component}>
    <slot {ref} />
  </T>
{/if}
